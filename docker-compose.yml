services:
  # =============================================
  # 3x-ui — Xray панель (VLESS + REALITY)
  # Веб-интерфейс + Xray-core в одном контейнере
  # =============================================
  3x-ui:
    image: ghcr.io/mhsanaei/3x-ui:latest
    container_name: 3x-ui
    restart: unless-stopped
    network_mode: host
    environment:
      - XRAY_VMESS_AEAD_FORCED=false
    volumes:
      - 3xui-db:/etc/x-ui/
      - 3xui-cert:/root/cert/
    tty: true
    depends_on:
      - warp
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================
  # Hysteria 2 — UDP-прокси (резервный протокол)
  # =============================================
  hysteria2:
    image: tobyxdd/hysteria:v2
    container_name: hysteria2
    restart: unless-stopped
    command: [ "server", "-c", "/etc/hysteria/config.yaml" ]
    ports:
      - "${HYSTERIA_PORT:-443}:443/udp"
    volumes:
      - ./hysteria2/config.yaml:/etc/hysteria/config.yaml:ro
      - hysteria2-cert:/etc/hysteria/cert/
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================
  # Cloudflare Warp — Приватный IP для Xray
  # =============================================
  warp:
    image: caomingjun/warp:latest
    container_name: vpn-warp
    restart: unless-stopped
    environment:
      - WARP_LICENSE_KEY=${WARP_LICENSE_KEY:-} # Можно добавить ключ Warp+
    cap_add:
      - NET_ADMIN
    volumes:
      - warp-conf:/var/lib/warp
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "1"

  # =============================================
  # AdGuard Home — Блокировка рекламы
  # =============================================
  adguard:
    image: adguard/adguardhome
    container_name: adguard
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./adguard/work:/opt/adguardhome/work
      - ./adguard/conf:/opt/adguardhome/conf
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  3xui-db:
    name: 3xui-db
  3xui-cert:
    name: 3xui-cert
  hysteria2-cert:
    name: hysteria2-cert
  warp-conf:
    name: warp-conf
