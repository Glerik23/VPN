services:
  # =============================================
  # 3x-ui — Xray панель (VLESS + REALITY)
  # Веб-интерфейс + Xray-core в одном контейнере
  # =============================================
  3x-ui:
    image: ghcr.io/mhsanaei/3x-ui:v2.3.8
    container_name: 3x-ui
    restart: unless-stopped
    network_mode: host
    environment:
      - XRAY_VMESS_AEAD_FORCED=false
    volumes:
      - 3xui-db:/etc/x-ui/
      - 3xui-cert:/root/cert/
      - ./logs/3x-ui:/etc/x-ui/access.log # Mount logs for Fail2Ban (if panel supports file logging)
    # 3x-ui doesn't always log to file by default, but we can mount the directory
    # For now, let's assume we want to mount the directory where logs reside
    tty: true
    depends_on:
      - warp
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================
  # Hysteria 2 — UDP-прокси (резервный протокол)
  # =============================================
  hysteria2:
    image: tobyxdd/hysteria:v2
    container_name: hysteria2
    restart: unless-stopped
    command: [ "server", "-c", "/etc/hysteria/config.yaml" ]
    ports:
      - "${HYSTERIA_PORT:-443}:443/udp"
    volumes:
      - ./hysteria2/config.yaml:/etc/hysteria/config.yaml:ro
      - ./hysteria2/cert:/etc/hysteria/cert/:ro
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================
  # Cloudflare Warp — Приватный IP для Xray
  # =============================================
  warp:
    image: caomingjun/warp:latest
    container_name: VPN-Warp
    restart: unless-stopped
    environment:
      - WARP_LICENSE_KEY=${WARP_LICENSE_KEY:-} # Можно добавить ключ Warp+
    cap_add:
      - NET_ADMIN
    volumes:
      - warp-conf:/var/lib/warp
    ports:
      - "127.0.0.1:1080:1080" # Local SOCKS5 proxy for Xray
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "1"

  # =============================================
  # AdGuard Home — Блокировка рекламы
  # =============================================
  adguard:
    image: adguard/adguardhome:v0.107.56
    container_name: adguard
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./adguard/work:/opt/adguardhome/work
      - ./adguard/conf:/opt/adguardhome/conf
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================
  # Watchtower — Автообновление контейнеров
  # =============================================
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --cleanup --schedule "0 0 4 * * *" # Updates every day at 4 AM

volumes:
  3xui-db:
    name: 3xui-db
  3xui-cert:
    name: 3xui-cert
  warp-conf:
    name: warp-conf
