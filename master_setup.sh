#!/usr/bin/env bash
# ============= master_setup.sh =============
# –ì–ª–∞–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
# ===========================================
set -euo pipefail

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
BLUE='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

info() { echo -e "${BLUE}[i]${NC} $1"; }
log()  { echo -e "${GREEN}[‚úì]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
err()  { echo -e "${RED}[‚úó]${NC} $1"; exit 1; }

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
error_handler() {
    local exit_code=$?
    local line_number=$1
    local command="$2"
    echo -e "${RED}[‚úó] –û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ $line_number: –∫–æ–º–∞–Ω–¥–∞ '$command' –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –∫–æ–¥–æ–º $exit_code${NC}"
    exit $exit_code
}
trap 'error_handler ${LINENO} "$BASH_COMMAND"' ERR

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ root
if [[ $EUID -ne 0 ]]; then
   err "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –æ—Ç –∏–º–µ–Ω–∏ root"
fi

PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$PROJECT_DIR"

clear
echo -e "${BLUE}"
echo "====================================================="
echo "   üöÄ VPN AUTO-INSTALLER: ALL-IN-ONE SETUP"
echo "====================================================="
echo -e "${NC}"

# 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ .env
info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
chmod +x scripts/*.sh

if [[ ! -f ".env" ]]; then
    info "–§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—é –∏–∑ .env.example..."
    cp .env.example .env
    warn "–§–∞–π–ª .env —Å–æ–∑–¥–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –µ–≥–æ (nano .env) –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞."
    exit 0
fi

# –ó–∞–ø—É—Å–∫ –∂–µ—Å—Ç–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
if ! ./scripts/00-pre-check.sh; then
    exit 1
fi

log "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞."

# 3. –ë–∞–∑–æ–≤–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
info "–®–∞–≥ 1/5: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å..."
./scripts/01-init-server.sh
log "–°–µ—Ä–≤–µ—Ä –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω."

# 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
info "–®–∞–≥ 2/5: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker..."
./scripts/02-install-docker.sh
log "Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."

# 5. –î–µ–ø–ª–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
info "–®–∞–≥ 3/5: –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (VPN, Warp, AdGuard)..."
./scripts/03-deploy.sh --no-prompt
log "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã."

# 6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram –ë–æ—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω)
source .env
if [[ -n "${TG_BOT_TOKEN:-}" ]]; then
    info "–®–∞–≥ 4/5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."
    ./scripts/09-setup-bot.sh
    log "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω."
else
    warn "TG_BOT_TOKEN –Ω–µ —É–∫–∞–∑–∞–Ω. –ü—Ä–æ–ø—É—Å–∫–∞—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞."
fi

# 7. –ê–≤—Ç–æ-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ü–∞–Ω–µ–ª–∏ –∏ AdGuard
info "–®–∞–≥ 5/5: –§–∏–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞–Ω–µ–ª–µ–π..."
./scripts/08-setup-inbound.sh
./scripts/10-setup-adguard.sh
log "–ü–∞–Ω–µ–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã."

echo -e "${GREEN}"
echo "====================================================="
echo "   ‚ú® –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û! ‚ú®"
echo "====================================================="
echo -e "${NC}"
info "–í–∞—à VPN –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ."
info "–í—ã–ø–æ–ª–Ω–∏—Ç–µ ./scripts/05-show-clients.sh –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫."
